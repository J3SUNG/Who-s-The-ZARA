pipeline {
    agent any

    stages {
        stage('Merge Opened') {
            when {
                expression {env.STATE == 'opened' && env.DETAIL_MERGE_STATUS == 'mergeable'}
            }
            steps {
                script {
                    mattermostSend color: '#439FE0', message: "Deployment has been started. ${env.BUILD_URL}"
                }
                echo 'Merge is opened.'
                withCredentials([usernamePassword(credentialsId: 'withCredential', usernameVariable: 'USERNAME', passwordVariable: 'TOKEN')]) {
                    sh "git pull https://${USERNAME}:${TOKEN}@lab.ssafy.com/s09-webmobile1-sub2/S09P12D206.git ${env.SOURCE_BRANCH}"
                }
                sh '''
                    docker stop react
                    docker stop spring

                    docker buildx build --tag react ../FE
                    docker run --rm -d -p 3000:3000/tcp react:latest

                    docker buildx build --tag spring ../BE
                    docker run --rm -d -p 8080:8080/tcp spring:latest
                '''
            }
        }
        stage('Merge Completed') {
            when {
                expression {env.STATE == 'merged'}
            }
            steps {
                script {
                    mattermostSend color: '#439FE0', message: "Deployment has been started. ${env.BUILD_URL}"
                }
                echo 'Merge is completed.'
                withCredentials([usernamePassword(credentialsId: 'withCredential', usernameVariable: 'USERNAME', passwordVariable: 'TOKEN')]) {
                    sh "git pull https://${USERNAME}:${TOKEN}@lab.ssafy.com/s09-webmobile1-sub2/S09P12D206.git master"
                }
                    sh 'which docker || echo docker not found'

                    sh '''
                    docker stop react
                    docker stop spring

                    docker buildx build --tag react ../FE
                    docker run --rm -d -p 3000:3000/tcp react:latest

                    docker buildx build --tag spring ../BE
                    docker run --rm -d -p 8080:8080/tcp spring:latest
                '''
            }
        }

    }

    post {
        success {
            script {
                mattermostSend color: 'good', message: "Deployment has been successful. ${env.BUILD_URL}"
            }
        }
        failure {
            script {
                mattermostSend color: 'danger', message: "Deployment has failed. ${env.BUILD_URL}"
            }
        }
    }
    
}
