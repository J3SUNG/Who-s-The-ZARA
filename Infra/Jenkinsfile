pipeline {
    agent any

    stages{
        stage('Merge Opened') {
            when {
                expression {env.STATE == 'opened' && env.DETAIL_MERGE_STATUS == 'mergeable'}
            }
            
            steps {
                script {
                    mattermostSend color: '#439FE0', message: "Deployment has been start. ${env.BUILD_URL}"
                }
                echo 'Merge is opened.'
                sh "git pull origin ${env.SOURCE_BRANCH}"
            }
        
        }
        stage('Merge Completed') {
            
            when {
                expression {env.STATE == 'merged'}
            }

            steps {
                script {
                    mattermostSend color: '#439FE0', message: "Deployment has been start. ${env.BUILD_URL}"
                }
                echo 'Merge is completed.'
                sh "git pull origin master"
            }
        }
    }

    post{
        success {
            script {
                mattermostSend color: 'good', message: "Deployment has been successful. ${env.BUILD_URL}"
            }
        }
        failure {
            script {
                mattermostSend color: 'danger', message: "Deployment has failed. ${env.BUILD_URL}"
            }
        }
    }
}