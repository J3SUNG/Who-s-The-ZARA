pipeline {
    agent any

    stages {
        stage('Merge Opened') {
            when {
                expression {env.STATE == 'opened' && env.DETAIL_MERGE_STATUS == 'mergeable'}
            }
            steps {
                script {
                    mattermostSend color: '#439FE0', message: "Deployment has been started. ${env.BUILD_URL}"
                }
                echo 'Merge is opened.'
                withCredentials([gitLabToken(credentialsId: 'gitLab-generic-webhook', variable: 'TOKEN')]) {
                    sh "git pull https://oauth2:${TOKEN}@lab.ssafy.com/s09-webmobile1-sub2/S09P12D206.git ${env.SOURCE_BRANCH}" 
                }
            }
        }
        stage('Merge Completed') {
            when {
                expression {env.STATE == 'merged'}
            }
            steps {
                script {
                    mattermostSend color: '#439FE0', message: "Deployment has been started. ${env.BUILD_URL}"
                }
                echo 'Merge is completed.'
                withCredentials([gitLabToken(credentialsId: 'gitLab-generic-webhook', variable: 'TOKEN')]) {
                    sh "git pull https://oauth2:${TOKEN}@lab.ssafy.com/s09-webmobile1-sub2/S09P12D206.git"
                }
            }
        }
    }
    post {
        success {
            script {
                mattermostSend color: 'good', message: "Deployment has been successful. ${env.BUILD_URL}"
            }
        }
        failure {
            script {
                mattermostSend color: 'danger', message: "Deployment has failed. ${env.BUILD_URL}"
            }
        }
    }
}
