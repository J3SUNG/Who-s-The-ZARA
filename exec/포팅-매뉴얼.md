# SSAFY D206 포팅 메뉴얼

# 목차

- [SSAFY D206 포팅 메뉴얼](#ssafy-d206-포팅-메뉴얼)
- [목차](#목차)
- [개발 및 배포 환경](#개발-및-배포-환경)
  - [프론트엔드](#프론트엔드)
  - [백엔드](#백엔드)
  - [Web RTC / socket](#web-rtc--socket)
- [배포 및 빌드](#배포-및-빌드)
  - [환경 변수](#환경-변수)
  - [EC2 ufw 설정 및 포트 개방](#ec2-ufw-설정-및-포트-개방)
    - [openVidu port](#openvidu-port)
    - [그 외 사용 port](#그-외-사용-port)
    - [ufw allow port](#ufw-allow-port)
  - [EC2 기본 패키지 설치](#ec2-기본-패키지-설치)
  - [SSL 인증서 발급](#ssl-인증서-발급)
  - [docker, docker-compose 설치](#docker-docker-compose-설치)
  - [nginx 설치 및 설정](#nginx-설치-및-설정)
  - [openVidu 설치 및 설정](#openvidu-설치-및-설정)
  - [react, spring, redis docker-compose 실행](#react-spring-redis-docker-compose-실행)
- [웹 사용 시나리오](#웹-사용-시나리오)
  - [회원가입](#회원가입)
  - [로그인](#로그인)
  - [게임 설명](#게임-설명)
  - [방 생성](#방-생성)
  - [방 입장](#방-입장)
  - [방 설정 변경](#방-설정-변경)
  - [방 채팅](#방-채팅)
  - [게임 시작](#게임-시작)
  - [카메라 및 음성 제어](#카메라-및-음성-제어)

# 개발 및 배포 환경

## 프론트엔드

VS CODE 1.81  
React Router Dom 6.14.1  
React 18.2.0  
TypeScript 5.0.2  
Node.js 18.17.1  
tailwindcss 3.3.3

## 백엔드

IntelliJ :  
JVM :  
Spring Boot :  
Maria DB :  
redis :

## Web RTC / socket

openvidu 2.28.0  
STOMP 7.0.0

# 배포 및 빌드

## 환경 변수

## EC2 ufw 설정 및 포트 개방

### openVidu port

- 22 TCP: to connect using SSH to admin OpenVidu.
- 80 TCP: if you select Let's Encrypt to generate an SSL certificate this port is used by the generation process.
- 443 TCP: OpenVidu server and application are published by default in standard https port.
- 3478 TCP+UDP: used by TURN server to resolve clients IPs.
- 40000 - 57000 TCP+UDP: used by Kurento Media Server to establish media connections.
- 57001 - 65535 TCP+UDP: used by TURN server to establish relayed media connections.

### 그 외 사용 port

- 80 : 리버스 프록시 nginx http
- 443 : 리버스 프록시 nginx https
- 6379 : openvidu redis
- 6380 : spring boot redis
- 3306 : Maria DB

### ufw allow port

```bash
ufw allow 80
ufw allow 443
ufw allow 18181
ufw allow 3478
ufw allow 40000:57000/tcp
ufw allow 40000:57000/udp
ufw allow 57001:65535/tcp
ufw allow 57001:65535/udp
```

## EC2 기본 패키지 설치

```bash
apt-get update

apt-get install ca-certificates curl gnupg
```

## SSL 인증서 발급

```bash
apt-get install letsencrypt -y

apt upgrade -y

apt install certbot python3-certbot-nginx

certbot certonly --standalone -d [도메인]
```

## docker, docker-compose 설치

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

apt-get update

apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

// 설치 확인
docker -v
docker compose version
```

## nginx 설치 및 설정

```bash
docker pull nginx

docker images

docker run -d -p 80:80 -p 443:443 --name nginx nginx

// 받은 SSL 인증서 파일을 컨테이너 안으로 복사
docker cp /etc/letsencrypt/archive/i9d206.p.ssafy.io/fullchain1.pem [컨테이너ID]:/etc/fullchain.pem
docker cp /etc/letsencrypt/archive/i9d206.p.ssafy.io/privkey1.pem [컨테이너ID]:/etc/privkey.pem

// 해당 컨테이너 안으로 들어가서 파일 수정하여 환경설정 해줘야
docker exec -it [컨테이너명] /bin/bash

// 컨테이너 안에서 에디터 되도록 설치하기
apt-get update
apt-get install vim nano

// 해당 디렉토리로 이동
cd "/etc/nginx"
```

```conf
// nginx.conf
# Set user and worker_processes
user nginx;
worker_processes auto;

# Error log and PID file
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # Include mime.types and set default_type
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Define log format for access_log
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # Set access_log path and log format
    access_log /var/log/nginx/access.log main;

    # Enable sendfile for better performance
    sendfile on;

    # Server block for the application with HTTPS
    server {
        listen 443 ssl;
        server_name i9d206.p.ssafy.io;

        ssl_certificate     /etc/fullchain.pem;
        ssl_certificate_key /etc/privkey.pem;

				location /api/v1/stomp {
				        proxy_pass http://i9d206.p.ssafy.io:8080;
				        proxy_http_version 1.1;
				        proxy_set_header Upgrade $http_upgrade;
				        proxy_set_header Connection "Upgrade";
				        proxy_set_header X-Real-IP $remote_addr;
				        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				        proxy_set_header Host $http_host;
				        proxy_read_timeout 21600000; # 6 * 60 * 60 * 1000
				        proxy_send_timeout 21600000; # 6 * 60 * 60 * 1000
				    }

				location /api/v1 {
            proxy_pass http://i9d206.p.ssafy.io:8080;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $http_host;
        }

        location / {
            proxy_pass http://i9d206.p.ssafy.io:3000;
        }
    }

    # Server block for react app
    server {
        listen 80;
        server_name i9d206.p.ssafy.io;
        location / {
            return 301 https://$host$request_uri;
        }
    }
}
```

## openVidu 설치 및 설정

## react, spring, redis docker-compose 실행

# 웹 사용 시나리오

## 회원가입

## 로그인

## 게임 설명

## 방 생성

## 방 입장

## 방 설정 변경

## 방 채팅

## 게임 시작

## 카메라 및 음성 제어
